<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DATA EDITORIAL / ANALYTICS v2.0</title>

  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">

  <!-- LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ================================================================
       CSS: TRIAL NAVY NOIR DESIGN SYSTEM
       ================================================================ -->
  <style>
    /* ==================== RESET & VARIABLES ==================== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --black: #000000;
      --white: #FFFFFF;
      --navy: #002B61;
      --navy-light: #003D8A;
      --navy-dark: #001A3D;
      --gray-100: #F5F5F5;
      --gray-200: #E5E5E5;
      --gray-300: #CCCCCC;
      --gray-400: #999999;
      --gray-500: #666666;
      --gray-600: #444444;
      --gray-700: #333333;
      --gray-800: #1A1A1A;
      --gray-900: #0D0D0D;
      --success: #00C853;
      --warning: #FF9100;
      --danger: #FF1744;
      --font-en: 'Helvetica Neue', 'Arial Black', sans-serif;
      --font-jp: 'Noto Sans JP', sans-serif;
    }

    html { font-size: 16px; scroll-behavior: smooth; }

    body {
      background: var(--black);
      color: var(--white);
      font-family: var(--font-jp);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* ==================== TYPOGRAPHY ==================== */
    .typo-massive {
      font-family: var(--font-en);
      font-size: clamp(64px, 12vw, 180px);
      font-weight: 900;
      letter-spacing: -0.05em;
      line-height: 0.85;
      text-transform: uppercase;
    }

    .typo-headline {
      font-family: var(--font-en);
      font-size: clamp(32px, 5vw, 64px);
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 0.9;
      text-transform: uppercase;
    }

    .typo-title {
      font-family: var(--font-en);
      font-size: clamp(18px, 2.5vw, 28px);
      font-weight: 700;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    .typo-label {
      font-family: var(--font-en);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    .typo-body { font-size: 14px; font-weight: 400; line-height: 1.7; }
    .typo-caption { font-size: 12px; color: var(--gray-400); }
    .typo-data {
      font-family: var(--font-en);
      font-size: clamp(28px, 4vw, 48px);
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    /* ==================== LAYOUT ==================== */
    .app { min-height: 100vh; }

    /* Header */
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      background: var(--black);
      border-bottom: 1px solid var(--gray-800);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 32px;
      border-bottom: 1px solid var(--gray-800);
    }

    .logo {
      font-family: var(--font-en);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.4em;
    }

    .header-nav {
      display: flex;
      gap: 0;
    }

    .nav-btn {
      padding: 12px 24px;
      font-family: var(--font-en);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--gray-500);
      background: transparent;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .nav-btn:hover { color: var(--white); }
    .nav-btn.active { color: var(--white); }
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--navy);
    }

    .nav-btn span {
      display: block;
      font-family: var(--font-jp);
      font-size: 9px;
      font-weight: 400;
      letter-spacing: 0.05em;
      opacity: 0.5;
      margin-top: 2px;
    }

    /* Slicer Bar */
    .slicer-bar {
      display: flex;
      align-items: center;
      padding: 10px 32px;
      gap: 8px;
      flex-wrap: wrap;
      background: var(--gray-900);
    }

    .slicer-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .slicer-label {
      font-size: 10px;
      color: var(--gray-500);
      margin-right: 6px;
      font-weight: 500;
    }

    .slicer-btn {
      padding: 5px 10px;
      font-family: var(--font-jp);
      font-size: 10px;
      font-weight: 500;
      color: var(--gray-400);
      background: transparent;
      border: 1px solid var(--gray-700);
      cursor: pointer;
      transition: all 0.15s;
    }

    .slicer-btn:hover {
      border-color: var(--navy);
      color: var(--white);
    }

    .slicer-btn.active {
      background: var(--navy);
      border-color: var(--navy);
      color: var(--white);
    }

    .slicer-divider {
      width: 1px;
      height: 20px;
      background: var(--gray-700);
      margin: 0 12px;
    }

    /* Main */
    .main { padding-top: 110px; }

    /* Hero */
    .hero {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: 55vh;
    }

    .hero-left {
      padding: 60px 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .hero-right {
      background: var(--navy);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .hero-right::before {
      content: 'ANALYTICS';
      position: absolute;
      font-family: var(--font-en);
      font-size: 160px;
      font-weight: 900;
      color: rgba(255,255,255,0.03);
      transform: rotate(-90deg);
      white-space: nowrap;
    }

    .hero-metric {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .hero-metric-label {
      font-size: 11px;
      letter-spacing: 0.3em;
      color: rgba(255,255,255,0.5);
      margin-bottom: 8px;
    }

    .hero-metric-value {
      font-family: var(--font-en);
      font-size: clamp(48px, 10vw, 100px);
      font-weight: 900;
      line-height: 1;
    }

    .hero-metric-sub {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-top: 12px;
    }

    /* Panels */
    .panel { display: none; padding: 48px 32px; }
    .panel.active { display: block; }

    /* Section */
    .section { margin-bottom: 48px; }
    .section-header { margin-bottom: 24px; }
    .section-num {
      font-family: var(--font-en);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.3em;
      color: var(--navy-light);
      margin-bottom: 6px;
    }
    .section-title-en {
      font-family: var(--font-en);
      font-size: clamp(24px, 3vw, 36px);
      font-weight: 900;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }
    .section-title-jp {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 6px;
    }

    /* Divider */
    .divider {
      height: 3px;
      background: var(--navy);
      margin: 48px 0;
    }
    .divider.thin {
      height: 1px;
      background: var(--gray-800);
    }

    /* Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--gray-800);
      margin-bottom: 32px;
    }

    .card {
      background: var(--black);
      padding: 24px;
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
    }

    .card:nth-child(1)::before { background: var(--navy); }
    .card:nth-child(2)::before { background: var(--white); }
    .card:nth-child(3)::before { background: var(--navy-light); }
    .card:nth-child(4)::before { background: var(--gray-500); }

    .card-label {
      font-size: 10px;
      letter-spacing: 0.12em;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .card-value {
      font-family: var(--font-en);
      font-size: 36px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 4px;
    }

    .card-sub { font-size: 11px; color: var(--gray-500); }
    .card-change { font-size: 11px; margin-top: 8px; }
    .card-change.up { color: var(--success); }
    .card-change.down { color: var(--danger); }

    /* Charts */
    .charts-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .charts-row.equal { grid-template-columns: 1fr 1fr; }
    .charts-row.triple { grid-template-columns: repeat(3, 1fr); }

    .chart-box {
      background: var(--gray-900);
      padding: 24px;
      position: relative;
    }

    .chart-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 60px; height: 3px;
      background: var(--navy);
    }

    .chart-box.alt::before { background: var(--gray-500); }

    .chart-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .chart-title {
      font-family: var(--font-en);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.1em;
    }

    .chart-subtitle {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .chart-area { height: 280px; position: relative; }
    .chart-area.tall { height: 360px; }
    .chart-area.short { height: 200px; }

    /* Store Simulation */
    .sim-container {
      background: var(--gray-900);
      padding: 24px;
      margin-bottom: 32px;
    }

    .sim-canvas-wrap {
      position: relative;
      width: 100%;
      height: 450px;
      background: var(--black);
      border: 1px solid var(--gray-700);
    }

    .sim-canvas {
      width: 100%;
      height: 100%;
    }

    .sim-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
    }

    .sim-btn {
      padding: 8px 20px;
      font-family: var(--font-en);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1em;
      background: var(--navy);
      border: none;
      color: var(--white);
      cursor: pointer;
      transition: background 0.2s;
    }

    .sim-btn:hover { background: var(--navy-light); }
    .sim-btn.stop { background: var(--danger); }

    .sim-stats {
      display: flex;
      gap: 24px;
      margin-left: auto;
    }

    .sim-stat {
      text-align: center;
    }

    .sim-stat-value {
      font-family: var(--font-en);
      font-size: 24px;
      font-weight: 900;
      color: var(--navy-light);
    }

    .sim-stat-label {
      font-size: 10px;
      color: var(--gray-500);
    }

    /* Heatmap */
    .heatmap-grid {
      display: grid;
      grid-template-columns: 40px repeat(13, 1fr);
      gap: 2px;
    }

    .heatmap-label {
      font-size: 10px;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }

    .heatmap-header {
      font-size: 9px;
      color: var(--gray-500);
      text-align: center;
      padding: 6px 0;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .heatmap-cell:hover { transform: scale(1.1); z-index: 10; }
    .heatmap-cell.l1 { background: rgba(0,43,97,0.2); color: var(--gray-500); }
    .heatmap-cell.l2 { background: rgba(0,43,97,0.4); color: var(--gray-300); }
    .heatmap-cell.l3 { background: rgba(0,43,97,0.6); color: var(--white); }
    .heatmap-cell.l4 { background: rgba(0,43,97,0.8); color: var(--white); }
    .heatmap-cell.l5 { background: var(--navy); color: var(--white); }

    /* Attribute Bars */
    .attr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .attr-card {
      background: var(--gray-900);
      padding: 20px;
    }

    .attr-card-title {
      font-family: var(--font-en);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--gray-300);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-700);
      margin-bottom: 16px;
    }

    .attr-row { margin-bottom: 12px; }

    .attr-row-head {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .attr-row-label { font-size: 12px; color: var(--gray-300); }
    .attr-row-value { font-family: var(--font-en); font-size: 12px; font-weight: 700; }

    .attr-row-bar {
      height: 18px;
      background: var(--gray-800);
      overflow: hidden;
    }

    .attr-row-fill {
      height: 100%;
      transition: width 0.6s ease;
    }

    .attr-row-fill.navy { background: var(--navy); }
    .attr-row-fill.light { background: var(--navy-light); }
    .attr-row-fill.white { background: var(--white); }

    /* RFM Matrix */
    .rfm-wrap {
      display: grid;
      grid-template-columns: 50px 1fr;
      gap: 8px;
    }

    .rfm-y {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      padding-top: 32px;
    }

    .rfm-y-label {
      font-size: 9px;
      color: var(--gray-500);
      text-align: right;
      padding-right: 8px;
    }

    .rfm-main { display: flex; flex-direction: column; }

    .rfm-x {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
      margin-bottom: 6px;
    }

    .rfm-x-label {
      font-size: 9px;
      color: var(--gray-500);
      text-align: center;
    }

    .rfm-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
    }

    .rfm-cell {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--gray-800);
      cursor: pointer;
      transition: transform 0.15s;
    }

    .rfm-cell:hover { transform: scale(1.02); }
    .rfm-cell.champion { background: var(--navy); }
    .rfm-cell.loyal { background: var(--navy-dark); }
    .rfm-cell.at-risk { background: var(--warning); }

    .rfm-cell-count {
      font-family: var(--font-en);
      font-size: 18px;
      font-weight: 900;
    }

    .rfm-cell-label {
      font-size: 8px;
      color: rgba(255,255,255,0.7);
      margin-top: 2px;
    }

    /* Entity List */
    .entity-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
    }

    .entity-list {
      background: var(--gray-900);
      max-height: 500px;
      overflow-y: auto;
    }

    .entity-item {
      padding: 14px 18px;
      border-bottom: 1px solid var(--gray-800);
      cursor: pointer;
      transition: background 0.15s;
    }

    .entity-item:hover, .entity-item.active { background: var(--gray-800); }
    .entity-item.active { border-left: 3px solid var(--navy); }

    .entity-rank {
      font-family: var(--font-en);
      font-size: 9px;
      color: var(--gray-500);
      letter-spacing: 0.1em;
    }

    .entity-name {
      font-family: var(--font-en);
      font-size: 14px;
      font-weight: 700;
      margin: 3px 0;
    }

    .entity-meta { font-size: 11px; color: var(--gray-500); }

    .entity-detail {
      background: var(--gray-900);
      padding: 28px;
    }

    .entity-profile {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--gray-700);
      margin-bottom: 24px;
    }

    .profile-stat { text-align: center; }

    .profile-stat-value {
      font-family: var(--font-en);
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 4px;
    }

    .profile-stat-value.navy { color: var(--navy-light); }

    .profile-stat-label {
      font-size: 10px;
      color: var(--gray-500);
      letter-spacing: 0.08em;
    }

    .radar-wrap { height: 240px; margin-bottom: 24px; }

    .timeline-list { max-height: 180px; overflow-y: auto; }

    .timeline-item {
      display: flex;
      gap: 16px;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-800);
    }

    .timeline-date {
      font-family: var(--font-en);
      font-size: 11px;
      color: var(--gray-500);
      min-width: 60px;
    }

    .timeline-amount {
      font-family: var(--font-en);
      font-size: 12px;
      font-weight: 700;
    }

    .timeline-items {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 2px;
    }

    /* Upload */
    .upload-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .upload-overlay.active { display: flex; }

    .upload-zone {
      width: 90%;
      max-width: 500px;
      padding: 60px;
      border: 2px dashed var(--gray-600);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--navy);
      background: rgba(0,43,97,0.1);
    }

    .upload-close {
      margin-top: 32px;
      padding: 10px 28px;
      background: transparent;
      border: 1px solid var(--gray-600);
      color: var(--white);
      font-family: var(--font-en);
      font-size: 11px;
      letter-spacing: 0.12em;
      cursor: pointer;
    }

    .upload-close:hover { background: var(--white); color: var(--black); }

    .btn {
      padding: 8px 16px;
      font-family: var(--font-en);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.12em;
      cursor: pointer;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray-600);
      color: var(--white);
    }

    .btn-outline:hover { background: var(--white); color: var(--black); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--black); }
    ::-webkit-scrollbar-thumb { background: var(--gray-700); }

    /* Responsive */
    @media (max-width: 1100px) {
      .hero { grid-template-columns: 1fr; }
      .hero-right { min-height: 300px; }
      .charts-row, .attr-grid, .entity-grid { grid-template-columns: 1fr; }
      .cards-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 700px) {
      .header-top { padding: 10px 16px; }
      .slicer-bar { padding: 10px 16px; }
      .panel { padding: 32px 16px; }
      .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- ================================================================
       HTML: STRUCTURE
       ================================================================ -->
  <div class="app">

    <!-- HEADER -->
    <header class="header">
      <div class="header-top">
        <div class="logo">DATA EDITORIAL</div>
        <div class="header-nav">
          <button class="nav-btn active" data-tab="trends">TRENDS<span>売上動向</span></button>
          <button class="nav-btn" data-tab="structure">STRUCTURE<span>商品構造</span></button>
          <button class="nav-btn" data-tab="n1">N1 ANALYSIS<span>顧客分析</span></button>
        </div>
        <button class="btn btn-outline" id="uploadBtn">CSV UPLOAD</button>
      </div>

      <div class="slicer-bar">
        <div class="slicer-group">
          <span class="slicer-label">性別</span>
          <button class="slicer-btn active" data-slicer="gender" data-value="all">全て</button>
          <button class="slicer-btn" data-slicer="gender" data-value="male">男性</button>
          <button class="slicer-btn" data-slicer="gender" data-value="female">女性</button>
        </div>
        <div class="slicer-divider"></div>
        <div class="slicer-group">
          <span class="slicer-label">年代</span>
          <button class="slicer-btn active" data-slicer="age" data-value="all">全て</button>
          <button class="slicer-btn" data-slicer="age" data-value="10">10代</button>
          <button class="slicer-btn" data-slicer="age" data-value="20">20代</button>
          <button class="slicer-btn" data-slicer="age" data-value="30">30代</button>
          <button class="slicer-btn" data-slicer="age" data-value="40">40代</button>
          <button class="slicer-btn" data-slicer="age" data-value="50">50代</button>
          <button class="slicer-btn" data-slicer="age" data-value="60">60代</button>
          <button class="slicer-btn" data-slicer="age" data-value="70">70代</button>
          <button class="slicer-btn" data-slicer="age" data-value="80">80代以上</button>
        </div>
        <div class="slicer-divider"></div>
        <div class="slicer-group">
          <span class="slicer-label">ライフステージ</span>
          <button class="slicer-btn active" data-slicer="life" data-value="all">全て</button>
          <button class="slicer-btn" data-slicer="life" data-value="single">単身</button>
          <button class="slicer-btn" data-slicer="life" data-value="dinks">DINKS</button>
          <button class="slicer-btn" data-slicer="life" data-value="dewks">DEWKS</button>
          <button class="slicer-btn" data-slicer="life" data-value="senior">老年夫婦</button>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">

      <!-- HERO -->
      <section class="hero">
        <div class="hero-left">
          <p class="typo-label" style="color: var(--gray-500); margin-bottom: 12px;">ANALYTICS PLATFORM v2.0</p>
          <h1 class="typo-massive">RETAIL</h1>
          <h1 class="typo-massive" style="color: var(--navy-light);">DATA</h1>
          <p class="typo-body" style="color: var(--gray-400); margin-top: 24px; max-width: 420px;">
            汎用リテール分析プラットフォーム。スライサーで属性を切り替え、売上・商品構造・顧客セグメントを即座に可視化します。
          </p>
        </div>
        <div class="hero-right">
          <div class="hero-metric">
            <p class="hero-metric-label">TOTAL REVENUE</p>
            <p class="hero-metric-value" id="heroRevenue">¥0</p>
            <p class="hero-metric-sub">2025年10月 集計</p>
          </div>
        </div>
      </section>

      <!-- PANEL: TRENDS -->
      <section class="panel active" id="panel-trends">
        <div class="cards-grid">
          <div class="card">
            <p class="card-label">取引件数</p>
            <p class="card-value" id="kpiTx">—</p>
            <p class="card-sub">Total Transactions</p>
            <p class="card-change up" id="kpiTxChg">—</p>
          </div>
          <div class="card">
            <p class="card-label">平均客単価</p>
            <p class="card-value" id="kpiBasket">—</p>
            <p class="card-sub">Avg. Basket</p>
            <p class="card-change up" id="kpiBasketChg">—</p>
          </div>
          <div class="card">
            <p class="card-label">顧客数</p>
            <p class="card-value" id="kpiCust">—</p>
            <p class="card-sub">Unique Customers</p>
            <p class="card-change up" id="kpiCustChg">—</p>
          </div>
          <div class="card">
            <p class="card-label">販売点数</p>
            <p class="card-value" id="kpiItems">—</p>
            <p class="card-sub">Items Sold</p>
            <p class="card-change up" id="kpiItemsChg">—</p>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <p class="section-num">01</p>
            <h2 class="section-title-en">DAILY REVENUE</h2>
            <p class="section-title-jp">日別売上推移 — 土日祝は色分け表示</p>
          </div>
          <div class="charts-row">
            <div class="chart-box">
              <div class="chart-head">
                <div>
                  <h3 class="chart-title">DAILY SALES</h3>
                  <p class="chart-subtitle">日別売上金額（10月）</p>
                </div>
              </div>
              <div class="chart-area tall"><canvas id="dailyChart"></canvas></div>
            </div>
            <div class="chart-box alt">
              <div class="chart-head">
                <div>
                  <h3 class="chart-title">HOURLY PATTERN</h3>
                  <p class="chart-subtitle">時間帯別来客指数</p>
                </div>
              </div>
              <div class="chart-area tall"><canvas id="hourlyChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section">
          <div class="section-header">
            <p class="section-num">02</p>
            <h2 class="section-title-en">CONGESTION HEATMAP</h2>
            <p class="section-title-jp">曜日×時間帯の混雑度 — 濃いほど混雑</p>
          </div>
          <div class="chart-box">
            <div class="heatmap-grid" id="heatmapGrid"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section">
          <div class="section-header">
            <p class="section-num">03</p>
            <h2 class="section-title-en">SHOPPER FLOW SIMULATION</h2>
            <p class="section-title-jp">店内動線シミュレーション — 入口から各ゾーンへの顧客移動を再現</p>
          </div>
          <div class="sim-container">
            <div class="sim-canvas-wrap">
              <canvas id="simCanvas" class="sim-canvas"></canvas>
            </div>
            <div class="sim-controls">
              <button class="sim-btn" id="simStart">START</button>
              <button class="sim-btn stop" id="simStop" style="display:none;">STOP</button>
              <div class="sim-stats">
                <div class="sim-stat">
                  <p class="sim-stat-value" id="simActive">0</p>
                  <p class="sim-stat-label">店内顧客数</p>
                </div>
                <div class="sim-stat">
                  <p class="sim-stat-value" id="simComplete">0</p>
                  <p class="sim-stat-label">退店済み</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL: STRUCTURE -->
      <section class="panel" id="panel-structure">
        <div class="section">
          <div class="section-header">
            <p class="section-num">01</p>
            <h2 class="section-title-en">CATEGORY SHARE</h2>
            <p class="section-title-jp">カテゴリ別売上構成</p>
          </div>
          <div class="charts-row">
            <div class="chart-box">
              <div class="chart-head">
                <div>
                  <h3 class="chart-title">REVENUE BY CATEGORY</h3>
                  <p class="chart-subtitle">カテゴリ別売上金額</p>
                </div>
              </div>
              <div class="chart-area tall"><canvas id="catChart"></canvas></div>
            </div>
            <div class="chart-box alt">
              <div class="chart-head">
                <div>
                  <h3 class="chart-title">TOP ITEMS</h3>
                  <p class="chart-subtitle">売上トップ商品</p>
                </div>
              </div>
              <div class="chart-area tall"><canvas id="topChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section">
          <div class="section-header">
            <p class="section-num">02</p>
            <h2 class="section-title-en">CUSTOMER ATTRIBUTES</h2>
            <p class="section-title-jp">顧客属性分布</p>
          </div>
          <div class="attr-grid">
            <div class="attr-card">
              <h4 class="attr-card-title">AGE / 年代</h4>
              <div id="attrAge"></div>
            </div>
            <div class="attr-card">
              <h4 class="attr-card-title">GENDER / 性別</h4>
              <div id="attrGender"></div>
            </div>
            <div class="attr-card">
              <h4 class="attr-card-title">LIFESTAGE / ライフステージ</h4>
              <div id="attrLife"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL: N1 -->
      <section class="panel" id="panel-n1">
        <div class="section">
          <div class="section-header">
            <p class="section-num">01</p>
            <h2 class="section-title-en">RFM MATRIX</h2>
            <p class="section-title-jp">RFM分析 — R:最終購買日 / M:購買金額</p>
          </div>
          <div class="chart-box">
            <div class="rfm-wrap">
              <div class="rfm-y">
                <div class="rfm-y-label">R5 最近</div>
                <div class="rfm-y-label">R4</div>
                <div class="rfm-y-label">R3</div>
                <div class="rfm-y-label">R2</div>
                <div class="rfm-y-label">R1 過去</div>
              </div>
              <div class="rfm-main">
                <div class="rfm-x">
                  <div class="rfm-x-label">M1 低</div>
                  <div class="rfm-x-label">M2</div>
                  <div class="rfm-x-label">M3</div>
                  <div class="rfm-x-label">M4</div>
                  <div class="rfm-x-label">M5 高</div>
                </div>
                <div class="rfm-grid" id="rfmGrid"></div>
              </div>
            </div>
            <div style="display:flex;gap:24px;margin-top:16px;">
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="width:14px;height:14px;background:var(--navy);"></div>
                <span class="typo-caption">優良顧客（Champion）</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="width:14px;height:14px;background:var(--navy-dark);"></div>
                <span class="typo-caption">ロイヤル顧客</span>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="width:14px;height:14px;background:var(--warning);"></div>
                <span class="typo-caption">要注意顧客</span>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section">
          <div class="section-header">
            <p class="section-num">02</p>
            <h2 class="section-title-en">N1 DEEP DIVE</h2>
            <p class="section-title-jp">個客深掘り分析</p>
          </div>
          <div class="entity-grid">
            <div class="entity-list" id="custList"></div>
            <div class="entity-detail" id="custDetail">
              <div style="text-align:center;padding:60px;color:var(--gray-500);">
                <p class="typo-label">SELECT CUSTOMER</p>
                <p class="typo-caption" style="margin-top:8px;">左のリストから選択してください</p>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- UPLOAD OVERLAY -->
    <div class="upload-overlay" id="uploadOverlay">
      <div class="upload-zone" id="uploadZone">
        <h2 class="typo-title" style="margin-bottom:12px;">DROP CSV FILE</h2>
        <p class="typo-body" style="color:var(--gray-400);">CSVをドラッグ＆ドロップ</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none;">
      </div>
      <button class="upload-close" id="uploadClose">閉じる</button>
    </div>

  </div>

  <!-- ================================================================
       JAVASCRIPT: LOGIC LAYER
       ================================================================ -->
  <script>
    // ================================================================
    // DEMO DATA
    // ================================================================
    const DATA = {
      dailySales: [],
      hourlySales: [],
      congestion: [],
      categories: [],
      topItems: [],
      ageDistribution: [],
      genderDistribution: [],
      lifeDistribution: [],
      customers: [],
      rfmMatrix: []
    };

    function generateData() {
      // Daily Sales (October 2025)
      const holidays = [13, 14];
      const weekends = [4, 5, 11, 12, 18, 19, 25, 26];
      DATA.dailySales = [];
      for (let d = 1; d <= 31; d++) {
        let base = 720000 + Math.random() * 200000;
        if (weekends.includes(d)) base *= 1.4;
        if (holidays.includes(d)) base *= 1.6;
        if (d <= 5 || d >= 25) base *= 1.1;
        const dow = new Date(2025, 9, d).getDay();
        DATA.dailySales.push({
          day: d,
          date: `10/${d}`,
          revenue: Math.round(base),
          isWeekend: dow === 0 || dow === 6,
          isHoliday: holidays.includes(d)
        });
      }

      // Hourly Sales
      DATA.hourlySales = [
        { hour: '9時', value: 40 }, { hour: '10時', value: 62 },
        { hour: '11時', value: 85 }, { hour: '12時', value: 78 },
        { hour: '13時', value: 65 }, { hour: '14時', value: 70 },
        { hour: '15時', value: 82 }, { hour: '16時', value: 90 },
        { hour: '17時', value: 100 }, { hour: '18時', value: 95 },
        { hour: '19時', value: 75 }, { hour: '20時', value: 48 },
        { hour: '21時', value: 22 }
      ];

      // Congestion Heatmap
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      DATA.congestion = [];
      for (let di = 0; di < 7; di++) {
        for (let h = 9; h <= 21; h++) {
          let val = 30 + Math.random() * 35;
          if (di === 0 || di === 6) val += 25;
          if (h >= 17 && h <= 19) val += 28;
          if (h >= 11 && h <= 13) val += 12;
          if (h >= 20) val -= 15;
          DATA.congestion.push({
            day: di, dayLabel: days[di], hour: h,
            value: Math.min(100, Math.max(10, Math.round(val)))
          });
        }
      }

      // Categories
      DATA.categories = [
        { name: '日配食品', revenue: 5400000 },
        { name: '加工食品', revenue: 4600000 },
        { name: '菓子', revenue: 3100000 },
        { name: '飲料', revenue: 2700000 },
        { name: '酒類', revenue: 2300000 },
        { name: '生鮮食品', revenue: 2000000 },
        { name: '冷凍食品', revenue: 1500000 },
        { name: '日用品', revenue: 1100000 },
        { name: '化粧品', revenue: 500000 }
      ];

      // Top Items
      DATA.topItems = [
        { name: 'プレミアム牛乳 1L', revenue: 980000 },
        { name: '食パン 6枚切', revenue: 620000 },
        { name: 'ミネラルウォーター 2L', revenue: 380000 },
        { name: 'カップヌードル', revenue: 680000 },
        { name: 'バナナ 1房', revenue: 460000 },
        { name: 'ヨーグルト 4個パック', revenue: 560000 },
        { name: '卵 10個入り', revenue: 690000 },
        { name: 'ポテトチップス', revenue: 420000 }
      ];

      // Age Distribution
      DATA.ageDistribution = [
        { label: '10代', value: 5 }, { label: '20代', value: 11 },
        { label: '30代', value: 17 }, { label: '40代', value: 23 },
        { label: '50代', value: 19 }, { label: '60代', value: 14 },
        { label: '70代', value: 8 }, { label: '80代以上', value: 3 }
      ];

      // Gender Distribution
      DATA.genderDistribution = [
        { label: '女性', value: 57 }, { label: '男性', value: 43 }
      ];

      // Lifestage Distribution
      DATA.lifeDistribution = [
        { label: '単身', value: 21 }, { label: 'DINKS', value: 17 },
        { label: 'DEWKS', value: 29 }, { label: '老年夫婦', value: 21 },
        { label: 'その他', value: 12 }
      ];

      // Customers
      const ages = ['10代', '20代', '30代', '40代', '50代', '60代', '70代', '80代以上'];
      const genders = ['女性', '男性'];
      const lifes = ['単身', 'DINKS', 'DEWKS', '老年夫婦', 'その他'];
      const cats = ['日配食品', '加工食品', '菓子', '飲料', '酒類'];
      DATA.customers = [];
      for (let i = 0; i < 50; i++) {
        const spend = Math.round(25000 + Math.random() * 480000);
        const visits = Math.round(2 + Math.random() * 48);
        DATA.customers.push({
          id: `CU${String(i + 1).padStart(5, '0')}`,
          totalSpend: spend,
          visits,
          avgBasket: Math.round(spend / visits),
          lastVisit: Math.round(1 + Math.random() * 28),
          age: ages[Math.floor(Math.random() * ages.length)],
          gender: genders[Math.floor(Math.random() * genders.length)],
          life: lifes[Math.floor(Math.random() * lifes.length)],
          topCat: cats[Math.floor(Math.random() * cats.length)],
          dna: {
            freq: Math.round(20 + Math.random() * 80),
            basket: Math.round(20 + Math.random() * 80),
            variety: Math.round(20 + Math.random() * 80),
            loyalty: Math.round(20 + Math.random() * 80),
            timing: Math.round(20 + Math.random() * 80)
          },
          timeline: Array.from({ length: 6 }, () => ({
            date: `10/${Math.round(1 + Math.random() * 28)}`,
            amount: Math.round(800 + Math.random() * 7000),
            items: Math.round(2 + Math.random() * 10)
          })).sort((a, b) => parseInt(b.date.split('/')[1]) - parseInt(a.date.split('/')[1]))
        });
      }
      DATA.customers.sort((a, b) => b.totalSpend - a.totalSpend);

      // RFM Matrix
      DATA.rfmMatrix = [];
      for (let r = 5; r >= 1; r--) {
        for (let m = 1; m <= 5; m++) {
          const isChamp = r >= 4 && m >= 4;
          const isLoyal = r >= 3 && m >= 3 && !isChamp;
          const isRisk = r <= 2 && m >= 4;
          let cnt;
          if (isChamp) cnt = Math.round(160 + Math.random() * 300);
          else if (isRisk) cnt = Math.round(30 + Math.random() * 70);
          else if (r <= 2 && m <= 2) cnt = Math.round(220 + Math.random() * 320);
          else cnt = Math.round(70 + Math.random() * 160);
          DATA.rfmMatrix.push({ r, m, count: cnt, isChamp, isLoyal, isRisk });
        }
      }
    }

    // ================================================================
    // STATE
    // ================================================================
    let charts = {};
    let slicers = { gender: 'all', age: 'all', life: 'all' };
    let simRunning = false, simAnimId = null, shoppers = [], simComplete = 0;

    // ================================================================
    // INIT
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
      generateData();
      initNav();
      initSlicers();
      initUpload();
      initSim();
      render();
    });

    // ================================================================
    // NAVIGATION
    // ================================================================
    function initNav() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
          document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');
        });
      });
    }

    // ================================================================
    // SLICERS
    // ================================================================
    function initSlicers() {
      document.querySelectorAll('.slicer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const s = btn.dataset.slicer;
          document.querySelectorAll(`.slicer-btn[data-slicer="${s}"]`).forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          slicers[s] = btn.dataset.value;
          render();
        });
      });
    }

    // ================================================================
    // UPLOAD
    // ================================================================
    function initUpload() {
      const overlay = document.getElementById('uploadOverlay');
      const zone = document.getElementById('uploadZone');
      const input = document.getElementById('fileInput');
      document.getElementById('uploadBtn').onclick = () => overlay.classList.add('active');
      document.getElementById('uploadClose').onclick = () => overlay.classList.remove('active');
      zone.onclick = () => input.click();
      zone.ondragover = e => { e.preventDefault(); zone.classList.add('drag-over'); };
      zone.ondragleave = () => zone.classList.remove('drag-over');
      zone.ondrop = e => { e.preventDefault(); zone.classList.remove('drag-over'); if (e.dataTransfer.files[0]) parseFile(e.dataTransfer.files[0]); };
      input.onchange = e => { if (e.target.files[0]) parseFile(e.target.files[0]); };
    }

    function parseFile(file) {
      Papa.parse(file, {
        header: true, skipEmptyLines: true, encoding: 'Shift_JIS',
        complete: r => {
          document.getElementById('uploadOverlay').classList.remove('active');
          alert(`${r.data.length}件のデータを読み込みました`);
        }
      });
    }

    // ================================================================
    // RENDER
    // ================================================================
    function render() {
      renderHero();
      renderKPIs();
      renderDailyChart();
      renderHourlyChart();
      renderHeatmap();
      renderCatChart();
      renderTopChart();
      renderAttrs();
      renderRFM();
      renderCustList();
    }

    function renderHero() {
      const total = DATA.dailySales.reduce((s, d) => s + d.revenue, 0);
      animateNum('heroRevenue', total, '¥', true);
    }

    function renderKPIs() {
      const total = DATA.dailySales.reduce((s, d) => s + d.revenue, 0);
      const tx = Math.round(total / 2850);
      animateNum('kpiTx', tx);
      animateNum('kpiBasket', Math.round(total / tx), '¥');
      animateNum('kpiCust', Math.round(tx * 0.7));
      animateNum('kpiItems', Math.round(tx * 4.3));
      document.getElementById('kpiTxChg').textContent = '+8.2% 前月比';
      document.getElementById('kpiBasketChg').textContent = '+3.1% 前月比';
      document.getElementById('kpiCustChg').textContent = '+5.5% 前月比';
      document.getElementById('kpiItemsChg').textContent = '+12.4% 前月比';
    }

    function animateNum(id, target, prefix = '', useMil = false) {
      const el = document.getElementById(id);
      const dur = 1000, start = performance.now();
      function step(now) {
        const p = Math.min((now - start) / dur, 1);
        const v = Math.round(target * (1 - Math.pow(1 - p, 3)));
        el.textContent = prefix + (useMil && v >= 1e6 ? (v / 1e6).toFixed(1) + 'M' : v.toLocaleString());
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      if (charts.daily) charts.daily.destroy();
      charts.daily = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: DATA.dailySales.map(d => d.date),
          datasets: [{
            data: DATA.dailySales.map(d => d.revenue),
            backgroundColor: DATA.dailySales.map(d =>
              d.isHoliday ? '#FFFFFF' : d.isWeekend ? '#003D8A' : '#002B61'
            ),
            borderRadius: 2
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666', font: { size: 9 }, maxRotation: 0 }, grid: { display: false } },
            y: { ticks: { color: '#666', callback: v => `¥${(v / 1e4).toFixed(0)}万` }, grid: { color: '#1A1A1A' } }
          }
        }
      });
    }

    function renderHourlyChart() {
      const ctx = document.getElementById('hourlyChart').getContext('2d');
      if (charts.hourly) charts.hourly.destroy();
      charts.hourly = new Chart(ctx, {
        type: 'line',
        data: {
          labels: DATA.hourlySales.map(d => d.hour),
          datasets: [{
            data: DATA.hourlySales.map(d => d.value),
            borderColor: '#002B61',
            backgroundColor: 'rgba(0,43,97,0.15)',
            fill: true, tension: 0.4,
            pointRadius: 4, pointBackgroundColor: '#002B61'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666' }, grid: { display: false } },
            y: { ticks: { color: '#666', callback: v => `${v}%` }, grid: { color: '#1A1A1A' }, min: 0, max: 120 }
          }
        }
      });
    }

    function renderHeatmap() {
      const cont = document.getElementById('heatmapGrid');
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      let html = '<div class="heatmap-header"></div>';
      for (let h = 9; h <= 21; h++) html += `<div class="heatmap-header">${h}時</div>`;
      days.forEach((d, di) => {
        html += `<div class="heatmap-label">${d}</div>`;
        for (let h = 9; h <= 21; h++) {
          const c = DATA.congestion.find(x => x.day === di && x.hour === h);
          const lv = Math.ceil(c.value / 20);
          html += `<div class="heatmap-cell l${lv}" title="${d}曜 ${h}時: ${c.value}%"></div>`;
        }
      });
      cont.innerHTML = html;
    }

    function renderCatChart() {
      const ctx = document.getElementById('catChart').getContext('2d');
      if (charts.cat) charts.cat.destroy();
      charts.cat = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: DATA.categories.map(c => c.name),
          datasets: [{
            data: DATA.categories.map(c => c.revenue),
            backgroundColor: DATA.categories.map((_, i) => i % 2 === 0 ? '#002B61' : '#003D8A'),
            borderRadius: 2
          }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666', callback: v => `¥${(v / 1e4).toFixed(0)}万` }, grid: { color: '#1A1A1A' } },
            y: { ticks: { color: '#CCC' }, grid: { display: false } }
          }
        }
      });
    }

    function renderTopChart() {
      const ctx = document.getElementById('topChart').getContext('2d');
      if (charts.top) charts.top.destroy();
      charts.top = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: DATA.topItems.map(i => i.name.slice(0, 10)),
          datasets: [{
            data: DATA.topItems.map(i => i.revenue),
            backgroundColor: '#002B61',
            borderRadius: 2
          }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666', callback: v => `¥${(v / 1e4).toFixed(0)}万` }, grid: { color: '#1A1A1A' } },
            y: { ticks: { color: '#CCC', font: { size: 10 } }, grid: { display: false } }
          }
        }
      });
    }

    function renderAttrs() {
      renderAttrBars('attrAge', DATA.ageDistribution, 'navy');
      renderAttrBars('attrGender', DATA.genderDistribution, 'light');
      renderAttrBars('attrLife', DATA.lifeDistribution, 'white');
    }

    function renderAttrBars(id, data, cls) {
      const max = Math.max(...data.map(d => d.value));
      document.getElementById(id).innerHTML = data.map(d => `
        <div class="attr-row">
          <div class="attr-row-head">
            <span class="attr-row-label">${d.label}</span>
            <span class="attr-row-value">${d.value}%</span>
          </div>
          <div class="attr-row-bar">
            <div class="attr-row-fill ${cls}" style="width:${(d.value / max) * 100}%"></div>
          </div>
        </div>
      `).join('');
    }

    function renderRFM() {
      document.getElementById('rfmGrid').innerHTML = DATA.rfmMatrix.map(c => {
        let cls = 'rfm-cell', lbl = '';
        if (c.isChamp) { cls += ' champion'; lbl = '優良'; }
        else if (c.isLoyal) { cls += ' loyal'; lbl = 'ロイヤル'; }
        else if (c.isRisk) { cls += ' at-risk'; lbl = '要注意'; }
        return `<div class="${cls}" title="R${c.r} x M${c.m}">
          <span class="rfm-cell-count">${c.count}</span>
          <span class="rfm-cell-label">${lbl}</span>
        </div>`;
      }).join('');
    }

    function renderCustList() {
      const cont = document.getElementById('custList');
      cont.innerHTML = DATA.customers.slice(0, 25).map((c, i) => `
        <div class="entity-item" data-idx="${i}">
          <p class="entity-rank">RANK #${i + 1}</p>
          <p class="entity-name">${c.id}</p>
          <p class="entity-meta">¥${c.totalSpend.toLocaleString()} / ${c.visits}回 / ${c.age} ${c.gender}</p>
        </div>
      `).join('');
      cont.querySelectorAll('.entity-item').forEach(el => {
        el.onclick = () => {
          cont.querySelectorAll('.entity-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
          renderCustDetail(DATA.customers[+el.dataset.idx]);
        };
      });
    }

    function renderCustDetail(c) {
      const cont = document.getElementById('custDetail');
      cont.innerHTML = `
        <div style="margin-bottom:20px;">
          <p class="typo-title" style="color:var(--navy-light)">${c.id}</p>
          <p class="typo-caption">${c.age} / ${c.gender} / ${c.life}</p>
        </div>
        <div class="entity-profile">
          <div class="profile-stat">
            <p class="profile-stat-value navy">¥${(c.totalSpend / 1000).toFixed(0)}K</p>
            <p class="profile-stat-label">総購買額</p>
          </div>
          <div class="profile-stat">
            <p class="profile-stat-value">${c.visits}</p>
            <p class="profile-stat-label">来店回数</p>
          </div>
          <div class="profile-stat">
            <p class="profile-stat-value">¥${c.avgBasket.toLocaleString()}</p>
            <p class="profile-stat-label">平均客単価</p>
          </div>
          <div class="profile-stat">
            <p class="profile-stat-value">${c.lastVisit}日前</p>
            <p class="profile-stat-label">最終来店</p>
          </div>
        </div>
        <div style="margin-bottom:20px;">
          <p class="typo-label" style="color:var(--gray-500);margin-bottom:12px;">顧客DNAレーダー</p>
          <div class="radar-wrap"><canvas id="radarChart"></canvas></div>
        </div>
        <div>
          <p class="typo-label" style="color:var(--gray-500);margin-bottom:12px;">購買タイムライン</p>
          <div class="timeline-list">${c.timeline.map(t => `
            <div class="timeline-item">
              <span class="timeline-date">${t.date}</span>
              <div>
                <p class="timeline-amount">¥${t.amount.toLocaleString()}</p>
                <p class="timeline-items">${t.items}点購入</p>
              </div>
            </div>
          `).join('')}</div>
        </div>
      `;
      renderRadar(c);
    }

    function renderRadar(c) {
      const ctx = document.getElementById('radarChart');
      if (!ctx) return;
      new Chart(ctx.getContext('2d'), {
        type: 'radar',
        data: {
          labels: ['購買頻度', '客単価', '多様性', 'ロイヤルティ', '時間帯'],
          datasets: [{
            data: [c.dna.freq, c.dna.basket, c.dna.variety, c.dna.loyalty, c.dna.timing],
            backgroundColor: 'rgba(0,43,97,0.25)',
            borderColor: '#002B61',
            borderWidth: 2,
            pointBackgroundColor: '#002B61'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            r: {
              beginAtZero: true, max: 100,
              ticks: { stepSize: 20, color: '#666', backdropColor: 'transparent' },
              grid: { color: '#333' },
              angleLines: { color: '#333' },
              pointLabels: { color: '#999', font: { size: 10 } }
            }
          }
        }
      });
    }

    // ================================================================
    // STORE SIMULATION
    // ================================================================
    const ZONES = [
      { id: 'entrance', name: '入口', x: 0.08, y: 0.5, color: '#00C853' },
      { id: 'fresh', name: '生鮮', x: 0.25, y: 0.25, color: '#002B61' },
      { id: 'meat', name: '精肉', x: 0.4, y: 0.2, color: '#003D8A' },
      { id: 'fish', name: '鮮魚', x: 0.55, y: 0.25, color: '#001A3D' },
      { id: 'deli', name: '惣菜', x: 0.7, y: 0.3, color: '#FF9100' },
      { id: 'dairy', name: '日配', x: 0.4, y: 0.55, color: '#002B61' },
      { id: 'processed', name: '加工食品', x: 0.6, y: 0.6, color: '#003D8A' },
      { id: 'register', name: 'レジ', x: 0.9, y: 0.5, color: '#FF1744' }
    ];

    const PATHS = {
      entrance: [{ to: 'fresh', prob: 0.6 }, { to: 'dairy', prob: 0.3 }, { to: 'processed', prob: 0.1 }],
      fresh: [{ to: 'meat', prob: 0.4 }, { to: 'fish', prob: 0.3 }, { to: 'deli', prob: 0.2 }, { to: 'register', prob: 0.1 }],
      meat: [{ to: 'fish', prob: 0.3 }, { to: 'deli', prob: 0.3 }, { to: 'dairy', prob: 0.2 }, { to: 'register', prob: 0.2 }],
      fish: [{ to: 'deli', prob: 0.4 }, { to: 'dairy', prob: 0.3 }, { to: 'register', prob: 0.3 }],
      deli: [{ to: 'dairy', prob: 0.3 }, { to: 'processed', prob: 0.3 }, { to: 'register', prob: 0.4 }],
      dairy: [{ to: 'processed', prob: 0.5 }, { to: 'register', prob: 0.5 }],
      processed: [{ to: 'register', prob: 1 }],
      register: []
    };

    function initSim() {
      document.getElementById('simStart').onclick = startSim;
      document.getElementById('simStop').onclick = stopSim;
      drawSimFrame();
    }

    function startSim() {
      if (simRunning) return;
      simRunning = true;
      shoppers = [];
      simComplete = 0;
      document.getElementById('simStart').style.display = 'none';
      document.getElementById('simStop').style.display = 'inline-block';
      simLoop();
      // Spawn shoppers periodically
      const spawner = setInterval(() => {
        if (!simRunning) { clearInterval(spawner); return; }
        if (shoppers.length < 40) spawnShopper();
      }, 600);
    }

    function stopSim() {
      simRunning = false;
      cancelAnimationFrame(simAnimId);
      document.getElementById('simStart').style.display = 'inline-block';
      document.getElementById('simStop').style.display = 'none';
    }

    function spawnShopper() {
      const entrance = ZONES.find(z => z.id === 'entrance');
      shoppers.push({
        x: entrance.x,
        y: entrance.y + (Math.random() - 0.5) * 0.1,
        zone: 'entrance',
        target: null,
        tx: entrance.x,
        ty: entrance.y,
        speed: 0.003 + Math.random() * 0.002,
        wait: 0
      });
    }

    function simLoop() {
      if (!simRunning) return;
      updateShoppers();
      drawSimFrame();
      document.getElementById('simActive').textContent = shoppers.length;
      document.getElementById('simComplete').textContent = simComplete;
      simAnimId = requestAnimationFrame(simLoop);
    }

    function updateShoppers() {
      shoppers.forEach(s => {
        if (s.wait > 0) { s.wait--; return; }

        // Move towards target
        const dx = s.tx - s.x, dy = s.ty - s.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 0.02) {
          // Arrived at target
          if (s.zone === 'register') {
            // Exit
            s.remove = true;
            simComplete++;
            return;
          }
          // Pick next zone
          const paths = PATHS[s.zone];
          if (paths.length === 0) { s.remove = true; simComplete++; return; }
          let r = Math.random(), cumul = 0;
          for (const p of paths) {
            cumul += p.prob;
            if (r <= cumul) {
              s.zone = p.to;
              const nextZone = ZONES.find(z => z.id === p.to);
              s.tx = nextZone.x + (Math.random() - 0.5) * 0.08;
              s.ty = nextZone.y + (Math.random() - 0.5) * 0.08;
              s.wait = Math.round(30 + Math.random() * 60); // Wait at zone
              break;
            }
          }
        } else {
          // Move
          s.x += (dx / dist) * s.speed;
          s.y += (dy / dist) * s.speed;
        }
      });
      shoppers = shoppers.filter(s => !s.remove);
    }

    function drawSimFrame() {
      const canvas = document.getElementById('simCanvas');
      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      const W = canvas.width, H = canvas.height;

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, W, H);

      // Draw zones
      ZONES.forEach(z => {
        ctx.fillStyle = z.color;
        ctx.globalAlpha = 0.3;
        ctx.beginPath();
        ctx.arc(z.x * W, z.y * H, 35, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.fillStyle = '#FFF';
        ctx.font = '11px "Noto Sans JP"';
        ctx.textAlign = 'center';
        ctx.fillText(z.name, z.x * W, z.y * H + 4);
      });

      // Draw paths
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      Object.entries(PATHS).forEach(([from, tos]) => {
        const fz = ZONES.find(z => z.id === from);
        tos.forEach(t => {
          const tz = ZONES.find(z => z.id === t.to);
          ctx.beginPath();
          ctx.moveTo(fz.x * W, fz.y * H);
          ctx.lineTo(tz.x * W, tz.y * H);
          ctx.stroke();
        });
      });

      // Draw shoppers
      shoppers.forEach(s => {
        ctx.fillStyle = '#00C853';
        ctx.beginPath();
        ctx.arc(s.x * W, s.y * H, 5, 0, Math.PI * 2);
        ctx.fill();
      });
    }

  </script>

</body>
</html>
