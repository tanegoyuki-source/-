<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DATA EDITORIAL / ANALYTICS v4.0</title>

  <!-- ================================================================
       FONTS
       ================================================================ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">

  <!-- ================================================================
       LIBRARIES
       ================================================================ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- ================================================================
       CSS: NEO-NOIR EDITORIAL DESIGN SYSTEM
       ================================================================ -->
  <style>
    /* ==================== RESET ==================== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ==================== CSS VARIABLES ==================== */
    :root {
      --black: #000000;
      --white: #FFFFFF;
      --navy: #002B61;
      --navy-light: #003D8A;
      --navy-dark: #001A3D;
      --emerald: #10B981;
      --gold: #F59E0B;
      --cyan: #06B6D4;
      --rose: #F43F5E;
      --violet: #8B5CF6;
      --teal: #14B8A6;
      --gray-400: #A3A3A3;
      --gray-500: #737373;
      --gray-600: #525252;
      --gray-700: #404040;
      --gray-800: #262626;
      --gray-900: #171717;
      --font-display: 'Montserrat', sans-serif;
      --font-jp: 'Noto Sans JP', sans-serif;
    }

    html { font-size: 16px; scroll-behavior: smooth; }

    body {
      background: var(--black);
      color: var(--white);
      font-family: var(--font-jp);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* ==================== TYPOGRAPHY ==================== */
    .typo-massive {
      font-family: var(--font-display);
      font-size: clamp(48px, 12vw, 160px);
      font-weight: 900;
      letter-spacing: -0.06em;
      line-height: 0.85;
      text-transform: uppercase;
    }

    .typo-display {
      font-family: var(--font-display);
      font-size: clamp(32px, 5vw, 72px);
      font-weight: 800;
      letter-spacing: -0.04em;
      line-height: 0.9;
      text-transform: uppercase;
    }

    .typo-headline {
      font-family: var(--font-display);
      font-size: clamp(20px, 3vw, 40px);
      font-weight: 700;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    .typo-title {
      font-family: var(--font-display);
      font-size: clamp(14px, 1.8vw, 24px);
      font-weight: 600;
      letter-spacing: -0.01em;
      text-transform: uppercase;
    }

    .typo-body { font-size: 15px; font-weight: 400; color: var(--gray-400); }
    .typo-caption { font-size: 12px; font-weight: 500; color: var(--gray-500); letter-spacing: 0.05em; }

    /* ==================== LAYOUT ==================== */
    .container { max-width: 1600px; margin: 0 auto; padding: 0 24px; }

    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    @media (max-width: 1200px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

    /* ==================== HEADER ==================== */
    header {
      padding: 48px 0 32px;
      border-bottom: 1px solid var(--gray-800);
      position: relative;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .brand-block h1 {
      font-family: var(--font-display);
      font-size: clamp(42px, 8vw, 100px);
      font-weight: 900;
      letter-spacing: -0.05em;
      line-height: 0.9;
      background: linear-gradient(135deg, var(--white) 0%, var(--cyan) 50%, var(--emerald) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .brand-block .tagline {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 8px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .version-badge {
      background: var(--navy);
      color: var(--cyan);
      padding: 8px 16px;
      font-family: var(--font-display);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.1em;
      border: 1px solid var(--cyan);
    }

    /* ==================== CSV UPLOADER ==================== */
    .upload-zone {
      background: linear-gradient(135deg, var(--gray-900) 0%, var(--black) 100%);
      border: 2px dashed var(--gray-700);
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 24px 0;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--cyan);
      background: linear-gradient(135deg, var(--navy-dark) 0%, var(--black) 100%);
    }

    .upload-zone h3 {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--white);
    }

    .upload-zone p { font-size: 13px; color: var(--gray-500); }

    #csvInput { display: none; }

    /* ==================== NAVIGATION TABS ==================== */
    .nav-tabs {
      display: flex;
      gap: 4px;
      margin: 32px 0 24px;
      border-bottom: 1px solid var(--gray-800);
      padding-bottom: 0;
    }

    .nav-btn {
      background: transparent;
      border: none;
      color: var(--gray-500);
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 700;
      padding: 16px 28px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .nav-btn span {
      display: block;
      font-family: var(--font-jp);
      font-size: 10px;
      font-weight: 400;
      margin-top: 4px;
      letter-spacing: 0;
      text-transform: none;
      opacity: 0.7;
    }

    .nav-btn:hover { color: var(--white); }

    .nav-btn.active {
      color: var(--cyan);
    }

    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--cyan);
    }

    /* ==================== TAB CONTENT ==================== */
    .tab-content { display: none; padding: 32px 0; }
    .tab-content.active { display: block; }

    /* ==================== CARDS ==================== */
    .card {
      background: var(--gray-900);
      border: 1px solid var(--gray-800);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--navy) 0%, var(--cyan) 100%);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .section-title-en {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: uppercase;
      color: var(--white);
    }

    .section-title-jp {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .card-badge {
      background: var(--navy);
      color: var(--cyan);
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 700;
      font-family: var(--font-display);
      letter-spacing: 0.1em;
    }

    /* ==================== KPI BLOCKS ==================== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }

    .kpi-block {
      background: linear-gradient(180deg, var(--gray-900) 0%, var(--black) 100%);
      border: 1px solid var(--gray-800);
      padding: 24px;
      position: relative;
    }

    .kpi-block::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .kpi-block.emerald::after { background: var(--emerald); }
    .kpi-block.cyan::after { background: var(--cyan); }
    .kpi-block.gold::after { background: var(--gold); }
    .kpi-block.rose::after { background: var(--rose); }

    .kpi-label {
      font-size: 11px;
      color: var(--gray-500);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-family: var(--font-display);
      font-size: clamp(28px, 4vw, 42px);
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1;
    }

    .kpi-block.emerald .kpi-value { color: var(--emerald); }
    .kpi-block.cyan .kpi-value { color: var(--cyan); }
    .kpi-block.gold .kpi-value { color: var(--gold); }
    .kpi-block.rose .kpi-value { color: var(--rose); }

    .kpi-sub {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 8px;
    }

    /* ==================== SIMULATION PANEL ==================== */
    .sim-panel {
      background: var(--black);
      border: 1px solid var(--gray-800);
      position: relative;
      overflow: hidden;
    }

    .sim-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-800);
      background: var(--gray-900);
    }

    .sim-title {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .sim-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .sim-btn {
      background: var(--navy);
      border: 1px solid var(--cyan);
      color: var(--cyan);
      padding: 8px 20px;
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .sim-btn:hover {
      background: var(--cyan);
      color: var(--black);
    }

    .sim-btn.running {
      background: var(--rose);
      border-color: var(--rose);
      color: var(--white);
    }

    .sim-stats {
      display: flex;
      gap: 24px;
      font-size: 12px;
      color: var(--gray-400);
    }

    .sim-stats span { color: var(--cyan); font-weight: 700; font-family: var(--font-display); }

    #simCanvas {
      width: 100%;
      height: 500px;
      display: block;
      background: var(--black);
    }

    .sim-legend {
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 16px;
      background: var(--gray-900);
      border-top: 1px solid var(--gray-800);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--gray-400);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* ==================== CHART CONTAINERS ==================== */
    .chart-container {
      position: relative;
      height: 280px;
    }

    .chart-container-lg { height: 360px; }
    .chart-container-xl { height: 450px; }

    /* ==================== HEATMAP ==================== */
    .heatmap-grid {
      display: grid;
      grid-template-columns: 60px repeat(24, 1fr);
      gap: 2px;
      font-size: 10px;
    }

    .heatmap-label {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: var(--gray-500);
      font-weight: 500;
    }

    .heatmap-hour {
      text-align: center;
      color: var(--gray-600);
      padding: 4px 0;
      font-family: var(--font-display);
      font-size: 9px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      min-height: 24px;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 10;
      box-shadow: 0 0 12px currentColor;
    }

    .heatmap-cell::after {
      content: attr(data-value);
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: 700;
      font-family: var(--font-display);
      color: transparent;
      transition: color 0.2s ease;
    }

    .heatmap-cell:hover::after { color: var(--white); }

    /* ==================== D3 NETWORK ==================== */
    #networkSvg {
      width: 100%;
      height: 400px;
      background: var(--black);
    }

    .network-node {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .network-node:hover { filter: brightness(1.3); }

    .network-link {
      stroke-opacity: 0.6;
      transition: stroke-opacity 0.3s ease;
    }

    .network-label {
      font-family: var(--font-display);
      font-size: 10px;
      font-weight: 700;
      fill: var(--white);
      text-anchor: middle;
      pointer-events: none;
    }

    /* ==================== RFM MATRIX ==================== */
    .rfm-matrix {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 3px;
      margin-top: 16px;
    }

    .rfm-header {
      background: var(--navy);
      color: var(--cyan);
      padding: 10px;
      text-align: center;
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 700;
    }

    .rfm-row-label {
      background: var(--navy);
      color: var(--cyan);
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 700;
    }

    .rfm-cell {
      padding: 12px 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 700;
      font-family: var(--font-display);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .rfm-cell:hover {
      transform: scale(1.05);
      z-index: 5;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    /* ==================== RADAR CHART ==================== */
    .persona-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 1000px) { .persona-grid { grid-template-columns: 1fr; } }

    .persona-card {
      background: var(--gray-900);
      border: 1px solid var(--gray-800);
      padding: 20px;
      text-align: center;
    }

    .persona-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .persona-tag {
      display: inline-block;
      background: var(--navy);
      color: var(--cyan);
      padding: 2px 10px;
      font-size: 10px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .persona-chart { height: 220px; }

    /* ==================== DEMOGRAPHIC BARS ==================== */
    .demo-section { margin-bottom: 32px; }

    .demo-title {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .demo-bar-container { margin-bottom: 12px; }

    .demo-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .demo-bar-label span:first-child { color: var(--gray-400); }
    .demo-bar-label span:last-child { color: var(--white); font-weight: 700; font-family: var(--font-display); }

    .demo-bar-track {
      height: 8px;
      background: var(--gray-800);
      overflow: hidden;
    }

    .demo-bar-fill {
      height: 100%;
      transition: width 0.8s ease;
    }

    /* ==================== N1 PROFILE ==================== */
    .n1-profile {
      background: linear-gradient(135deg, var(--navy-dark) 0%, var(--gray-900) 100%);
      border: 1px solid var(--navy);
      padding: 24px;
      margin-top: 24px;
    }

    .n1-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .n1-avatar {
      width: 64px;
      height: 64px;
      background: var(--navy);
      border: 2px solid var(--cyan);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 900;
      color: var(--cyan);
    }

    .n1-meta h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .n1-tags {
      display: flex;
      gap: 8px;
    }

    .n1-tag {
      background: var(--gray-800);
      color: var(--gray-400);
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 600;
    }

    .n1-tag.highlight { background: var(--emerald); color: var(--black); }

    .n1-narrative {
      font-size: 14px;
      line-height: 1.8;
      color: var(--gray-400);
    }

    .n1-narrative strong { color: var(--white); }

    .n1-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-700);
    }

    .n1-stat {
      text-align: center;
    }

    .n1-stat-value {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 800;
      color: var(--cyan);
    }

    .n1-stat-label {
      font-size: 10px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    /* ==================== FOOTER ==================== */
    footer {
      border-top: 1px solid var(--gray-800);
      padding: 32px 0;
      margin-top: 48px;
      text-align: center;
    }

    .footer-text {
      font-size: 11px;
      color: var(--gray-600);
      letter-spacing: 0.1em;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor; } }

    .animate-pulse { animation: pulse 2s infinite; }
  </style>
</head>

<body>
  <!-- ================================================================
       HTML STRUCTURE
       ================================================================ -->

  <div class="container">
    <!-- ==================== HEADER ==================== -->
    <header>
      <div class="header-top">
        <div class="brand-block">
          <h1>DATA EDITORIAL</h1>
          <p class="tagline">Universal Retail Analytics Platform</p>
        </div>
        <div class="version-badge">VERSION 4.0</div>
      </div>

      <!-- CSV UPLOAD -->
      <div class="upload-zone" id="uploadZone">
        <h3>DROP CSV HERE</h3>
        <p>任意のPOSデータをドラッグ＆ドロップ、またはクリックして選択</p>
        <input type="file" id="csvInput" accept=".csv">
      </div>
    </header>

    <!-- ==================== NAVIGATION ==================== -->
    <nav class="nav-tabs">
      <button class="nav-btn active" data-tab="flow">FLOW<span>買物動線</span></button>
      <button class="nav-btn" data-tab="trend">TREND<span>時系列分析</span></button>
      <button class="nav-btn" data-tab="structure">STRUCTURE<span>商品構造</span></button>
      <button class="nav-btn" data-tab="customer">CUSTOMER<span>顧客DNA</span></button>
    </nav>

    <!-- ==================== KPI SUMMARY ==================== -->
    <section class="kpi-grid">
      <div class="kpi-block emerald">
        <div class="kpi-label">Total Revenue</div>
        <div class="kpi-value" id="kpiRevenue">¥0</div>
        <div class="kpi-sub">月間売上高</div>
      </div>
      <div class="kpi-block cyan">
        <div class="kpi-label">Transactions</div>
        <div class="kpi-value" id="kpiTx">0</div>
        <div class="kpi-sub">総客数</div>
      </div>
      <div class="kpi-block gold">
        <div class="kpi-label">Avg Basket</div>
        <div class="kpi-value" id="kpiBasket">¥0</div>
        <div class="kpi-sub">客単価</div>
      </div>
      <div class="kpi-block rose">
        <div class="kpi-label">Visit Freq</div>
        <div class="kpi-value" id="kpiFreq">0.0</div>
        <div class="kpi-sub">来店頻度/月</div>
      </div>
    </section>

    <!-- ==================== TAB 1: FLOW SIMULATION ==================== -->
    <div class="tab-content active" id="tab-flow">
      <div class="sim-panel">
        <div class="sim-header">
          <div>
            <div class="sim-title">Abstract Retail Graph</div>
            <div style="font-size:11px;color:var(--gray-500);margin-top:4px;">ノード連結型の買物行動シミュレーション — 確率遷移モデル</div>
          </div>
          <div class="sim-controls">
            <div class="sim-stats">
              Active: <span id="simActive">0</span> &nbsp;|&nbsp; Complete: <span id="simComplete">0</span> &nbsp;|&nbsp; Avg: <span id="simAvgTime">0.0</span>s
            </div>
            <button class="sim-btn" id="simToggle">START</button>
          </div>
        </div>
        <canvas id="simCanvas"></canvas>
        <div class="sim-legend">
          <div class="legend-item"><div class="legend-dot" style="background:var(--emerald)"></div>ENTRANCE / PRODUCE</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--rose)"></div>MEAT / FISH</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div>DELI / BAKERY</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div>CENTER / BEVERAGE</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--white)"></div>CHECKOUT</div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: TREND ==================== -->
    <div class="tab-content" id="tab-trend">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Daily Trend</h2>
              <p class="section-title-jp">日別売上推移 — 10月度</p>
            </div>
            <div class="card-badge">LINE</div>
          </div>
          <div class="chart-container chart-container-lg">
            <canvas id="chartDaily"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Hourly Pattern</h2>
              <p class="section-title-jp">時間帯別来店パターン</p>
            </div>
            <div class="card-badge">BAR</div>
          </div>
          <div class="chart-container chart-container-lg">
            <canvas id="chartHourly"></canvas>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:24px;">
        <div class="card-header">
          <div>
            <h2 class="section-title-en">Day × Hour Heatmap</h2>
            <p class="section-title-jp">曜日×時間帯の売上強度マトリクス（月曜始まり・0円データ除外）</p>
          </div>
          <div class="card-badge">MATRIX</div>
        </div>
        <div id="heatmapContainer" style="overflow-x:auto;margin-top:16px;"></div>
      </div>
    </div>

    <!-- ==================== TAB 3: STRUCTURE ==================== -->
    <div class="tab-content" id="tab-structure">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Category Share</h2>
              <p class="section-title-jp">カテゴリ別売上構成比</p>
            </div>
            <div class="card-badge">DOUGHNUT</div>
          </div>
          <div class="chart-container chart-container-lg">
            <canvas id="chartCategory"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Basket Affinity</h2>
              <p class="section-title-jp">併売相関ネットワーク — カテゴリ間の購買連動性</p>
            </div>
            <div class="card-badge">D3 NETWORK</div>
          </div>
          <svg id="networkSvg"></svg>
        </div>
      </div>

      <div class="card" style="margin-top:24px;">
        <div class="card-header">
          <div>
            <h2 class="section-title-en">Category Breakdown</h2>
            <p class="section-title-jp">全カテゴリ詳細（青果・製菓・日配等を含む）</p>
          </div>
        </div>
        <div class="chart-container chart-container-xl">
          <canvas id="chartCategoryBar"></canvas>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 4: CUSTOMER ==================== -->
    <div class="tab-content" id="tab-customer">
      <div class="grid-3">
        <!-- GENDER -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Gender</h2>
              <p class="section-title-jp">性別構成（男→女）</p>
            </div>
          </div>
          <div id="genderBars"></div>
        </div>

        <!-- AGE -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Age Segment</h2>
              <p class="section-title-jp">年代別（10代→80代以上）</p>
            </div>
          </div>
          <div id="ageBars"></div>
        </div>

        <!-- LIFESTAGE -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="section-title-en">Lifestage</h2>
              <p class="section-title-jp">ライフステージ別</p>
            </div>
          </div>
          <div id="lifeBars"></div>
        </div>
      </div>

      <!-- RFM MATRIX -->
      <div class="card" style="margin-top:24px;">
        <div class="card-header">
          <div>
            <h2 class="section-title-en">RFM Segmentation</h2>
            <p class="section-title-jp">顧客ロイヤリティマトリクス — Recency × Frequency × Monetary</p>
          </div>
          <div class="card-badge">INSIGHT</div>
        </div>
        <div id="rfmMatrix"></div>
      </div>

      <!-- PERSONA RADAR -->
      <div class="card" style="margin-top:24px;">
        <div class="card-header">
          <div>
            <h2 class="section-title-en">Persona Radar</h2>
            <p class="section-title-jp">代表的顧客ペルソナの行動特性</p>
          </div>
        </div>
        <div class="persona-grid" id="personaGrid"></div>
      </div>

      <!-- N1 NARRATIVE -->
      <div class="n1-profile" id="n1Profile">
        <div class="n1-header">
          <div class="n1-avatar">N1</div>
          <div class="n1-meta">
            <h3 id="n1Name">読み込み中...</h3>
            <div class="n1-tags" id="n1Tags"></div>
          </div>
        </div>
        <p class="n1-narrative" id="n1Narrative">データを読み込むと、最も特徴的な顧客像を日本語で要約します。</p>
        <div class="n1-stats" id="n1Stats"></div>
      </div>
    </div>

    <!-- ==================== FOOTER ==================== -->
    <footer>
      <p class="footer-text">DATA EDITORIAL / UNIVERSAL RETAIL ANALYTICS — VERSION 4.0</p>
    </footer>
  </div>

  <!-- ================================================================
       JAVASCRIPT
       ================================================================ -->
  <script>
    /* ==================== GLOBAL DATA STORE ==================== */
    const DATA = {
      raw: [],
      daily: [],
      hourly: [],
      heatmap: [],
      categories: [],
      categoryDetails: [],
      genderDist: [],
      ageDist: [],
      lifeDist: [],
      rfm: [],
      personas: [],
      n1: null,
      kpi: { revenue: 0, transactions: 0, basket: 0, frequency: 0 }
    };

    /* ==================== COLUMN AUTO-DETECTION ==================== */
    const COLUMN_ALIASES = {
      date: ['date', '日付', '購買日', 'transaction_date', 'sale_date', '取引日'],
      amount: ['amount', '金額', '売上', 'revenue', 'price', 'total', '売上金額', '購買金額'],
      customerId: ['customer_id', '顧客ID', '会員番号', 'member_id', 'id', 'カード番号'],
      gender: ['gender', '性別', 'sex'],
      age: ['age', '年代', '年齢', 'age_group', '年齢層'],
      category: ['category', 'カテゴリ', '商品分類', 'product_category', '部門', '商品カテゴリ'],
      lifestage: ['lifestage', 'ライフステージ', 'life_stage', 'household', '世帯構成'],
      hour: ['hour', '時間', '時刻', 'time']
    };

    function detectColumn(headers, aliases) {
      const lowerHeaders = headers.map(h => h.toLowerCase().trim());
      for (const alias of aliases) {
        const idx = lowerHeaders.indexOf(alias.toLowerCase());
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    /* ==================== STRICT SORTING ORDERS ==================== */
    const SORT_ORDER = {
      gender: ['男', '女'],
      age: ['10代', '20代', '30代', '40代', '50代', '60代', '70代', '80代以上'],
      lifestage: ['単身', 'DINKS', 'DEWKS', '老年夫婦', 'その他']
    };

    function sortByOrder(arr, orderKey, labelKey = 'label') {
      const order = SORT_ORDER[orderKey];
      if (!order) return arr;
      return arr.sort((a, b) => {
        const idxA = order.indexOf(a[labelKey]);
        const idxB = order.indexOf(b[labelKey]);
        return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
      });
    }

    /* ==================== DEMO DATA GENERATOR ==================== */
    function generateDemoData() {
      // KPI
      DATA.kpi = { revenue: 847520000, transactions: 312450, basket: 2712, frequency: 4.2 };

      // Daily (October 2025, 31 days)
      DATA.daily = [];
      const baseDaily = [24.8, 26.2, 28.5, 32.1, 29.3, 38.2, 35.6, 25.1, 27.4, 29.8, 31.2, 28.7, 36.8, 34.2, 26.3, 28.9, 30.5, 32.8, 29.1, 37.5, 33.9, 25.8, 27.1, 29.5, 31.8, 28.4, 35.2, 32.6, 24.5, 26.8, 28.2];
      for (let d = 1; d <= 31; d++) {
        DATA.daily.push({ day: d, revenue: baseDaily[d-1] * 1000000 * (0.9 + Math.random() * 0.2) });
      }

      // Hourly (realistic pattern, no zeros)
      DATA.hourly = [
        { hour: 9, value: 1850 }, { hour: 10, value: 4520 }, { hour: 11, value: 6230 },
        { hour: 12, value: 5180 }, { hour: 13, value: 4890 }, { hour: 14, value: 5340 },
        { hour: 15, value: 6720 }, { hour: 16, value: 7890 }, { hour: 17, value: 8450 },
        { hour: 18, value: 7210 }, { hour: 19, value: 5680 }, { hour: 20, value: 3420 },
        { hour: 21, value: 1820 }
      ];

      // Heatmap (Monday-start: 月火水木金土日)
      const days = ['月', '火', '水', '木', '金', '土', '日'];
      const heatBase = [
        [0,0,0,0,0,0,0,0,0,18,42,58,48,45,52,65,78,82,68,54,32,18,0,0],
        [0,0,0,0,0,0,0,0,0,16,38,52,44,42,48,62,74,78,64,50,28,15,0,0],
        [0,0,0,0,0,0,0,0,0,20,45,62,52,48,55,68,82,88,72,58,35,20,0,0],
        [0,0,0,0,0,0,0,0,0,17,40,55,46,44,50,64,76,80,66,52,30,16,0,0],
        [0,0,0,0,0,0,0,0,0,22,48,68,58,54,62,75,92,98,82,65,42,24,0,0],
        [0,0,0,0,0,0,0,0,0,28,58,82,72,68,78,95,100,95,88,72,48,28,0,0],
        [0,0,0,0,0,0,0,0,0,25,52,75,65,62,70,85,92,88,78,62,40,22,0,0]
      ];
      DATA.heatmap = days.map((day, di) => ({
        day,
        hours: heatBase[di].map((v, h) => ({ hour: h, value: v > 0 ? v : 0 }))
      }));

      // Categories with full breakdown
      DATA.categories = [
        { name: '青果', value: 18.5, color: '#10B981' },
        { name: '精肉', value: 15.2, color: '#F43F5E' },
        { name: '鮮魚', value: 11.8, color: '#06B6D4' },
        { name: '惣菜', value: 14.3, color: '#F59E0B' },
        { name: '日配', value: 12.6, color: '#8B5CF6' },
        { name: '飲料', value: 8.4, color: '#14B8A6' },
        { name: '製菓', value: 6.2, color: '#EC4899' },
        { name: '酒類', value: 5.8, color: '#EF4444' },
        { name: '冷凍', value: 4.5, color: '#3B82F6' },
        { name: 'その他', value: 2.7, color: '#6B7280' }
      ];

      DATA.categoryDetails = [
        { name: '青果', revenue: 156820000, share: 18.5, growth: 3.2, basket: 1.8 },
        { name: '精肉', revenue: 128920000, share: 15.2, growth: 2.1, basket: 1.5 },
        { name: '惣菜', revenue: 121280000, share: 14.3, growth: 5.8, basket: 1.9 },
        { name: '日配', revenue: 106840000, share: 12.6, growth: 1.2, basket: 2.1 },
        { name: '鮮魚', revenue: 100040000, share: 11.8, growth: -0.5, basket: 1.3 },
        { name: '飲料', revenue: 71220000, share: 8.4, growth: 4.2, basket: 1.6 },
        { name: '製菓', revenue: 52540000, share: 6.2, growth: 2.8, basket: 1.4 },
        { name: '酒類', revenue: 49160000, share: 5.8, growth: 1.5, basket: 1.2 },
        { name: '冷凍', revenue: 38140000, share: 4.5, growth: 6.5, basket: 1.7 },
        { name: 'その他', revenue: 22560000, share: 2.7, growth: 0.8, basket: 0.9 }
      ];

      // Demographics (strict order)
      DATA.genderDist = sortByOrder([
        { label: '男', value: 41 },
        { label: '女', value: 59 }
      ], 'gender');

      DATA.ageDist = sortByOrder([
        { label: '10代', value: 3 },
        { label: '20代', value: 8 },
        { label: '30代', value: 15 },
        { label: '40代', value: 25 },
        { label: '50代', value: 21 },
        { label: '60代', value: 16 },
        { label: '70代', value: 9 },
        { label: '80代以上', value: 3 }
      ], 'age');

      DATA.lifeDist = sortByOrder([
        { label: '単身', value: 20 },
        { label: 'DINKS', value: 16 },
        { label: 'DEWKS', value: 32 },
        { label: '老年夫婦', value: 22 },
        { label: 'その他', value: 10 }
      ], 'lifestage');

      // RFM Matrix
      DATA.rfm = [
        { r: 'High', f: 'High', m: 'High', count: 2840, label: 'Champion', color: '#10B981' },
        { r: 'High', f: 'High', m: 'Mid', count: 4520, label: 'Loyal', color: '#06B6D4' },
        { r: 'High', f: 'Mid', m: 'High', count: 3180, label: 'Potential', color: '#8B5CF6' },
        { r: 'Mid', f: 'High', m: 'Mid', count: 5640, label: 'Promising', color: '#F59E0B' },
        { r: 'Mid', f: 'Mid', m: 'Mid', count: 8920, label: 'Average', color: '#6B7280' },
        { r: 'Low', f: 'Low', m: 'Low', count: 3450, label: 'At Risk', color: '#F43F5E' }
      ];

      // Personas
      DATA.personas = [
        {
          name: '健康志向ファミリー',
          tag: 'DEWKS',
          color: '#10B981',
          scores: { 健康志向: 92, 利便性: 48, 価格感度: 55, 品揃え: 78, ロイヤリティ: 85 }
        },
        {
          name: '時短重視シングル',
          tag: '単身',
          color: '#06B6D4',
          scores: { 健康志向: 42, 利便性: 95, 価格感度: 68, 品揃え: 52, ロイヤリティ: 38 }
        },
        {
          name: '品質重視シニア',
          tag: '老年夫婦',
          color: '#F59E0B',
          scores: { 健康志向: 75, 利便性: 58, 価格感度: 35, 品揃え: 62, ロイヤリティ: 92 }
        }
      ];

      // N1 Profile
      DATA.n1 = {
        id: 'CX-284719',
        name: '山田 花子 様',
        age: '50代',
        gender: '女',
        lifestage: 'DEWKS',
        rfmRank: 'Champion',
        narrative: '週に<strong>3.2回</strong>来店される、当店の最も大切なお客様のお一人です。<strong>青果と惣菜</strong>を中心に購入され、特に<strong>有機野菜</strong>への関心が高い傾向があります。お子様がいらっしゃる共働き世帯と推測され、<strong>時短</strong>と<strong>健康</strong>の両立を重視されています。日曜日の午前中に来店されることが多く、まとめ買い傾向が顕著です。直近3ヶ月で<strong>¥128,450</strong>をお買い上げいただいており、ロイヤリティスコアは上位<strong>2.1%</strong>に位置します。',
        stats: { visits: 42, spend: 128450, basket: 3058, loyalty: '上位2.1%' }
      };
    }

    /* ==================== CHART.JS SETUP ==================== */
    Chart.defaults.color = '#A3A3A3';
    Chart.defaults.borderColor = '#404040';
    Chart.defaults.font.family = "'Montserrat', 'Noto Sans JP', sans-serif";

    const chartInstances = {};

    function destroyChart(id) {
      if (chartInstances[id]) {
        chartInstances[id].destroy();
        delete chartInstances[id];
      }
    }

    /* ==================== RENDER FUNCTIONS ==================== */
    function renderKPI() {
      document.getElementById('kpiRevenue').textContent = '¥' + (DATA.kpi.revenue / 100000000).toFixed(1) + '億';
      document.getElementById('kpiTx').textContent = DATA.kpi.transactions.toLocaleString();
      document.getElementById('kpiBasket').textContent = '¥' + DATA.kpi.basket.toLocaleString();
      document.getElementById('kpiFreq').textContent = DATA.kpi.frequency.toFixed(1) + '回';
    }

    function renderDailyChart() {
      destroyChart('chartDaily');
      const ctx = document.getElementById('chartDaily').getContext('2d');
      chartInstances['chartDaily'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: DATA.daily.map(d => d.day + '日'),
          datasets: [{
            label: '売上',
            data: DATA.daily.map(d => d.revenue / 1000000),
            borderColor: '#06B6D4',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#06B6D4',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => '¥' + ctx.raw.toFixed(1) + 'M'
              }
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              grid: { color: '#262626' },
              ticks: { callback: v => '¥' + v + 'M' }
            }
          }
        }
      });
    }

    function renderHourlyChart() {
      destroyChart('chartHourly');
      const ctx = document.getElementById('chartHourly').getContext('2d');
      chartInstances['chartHourly'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: DATA.hourly.map(h => h.hour + '時'),
          datasets: [{
            label: '来店数',
            data: DATA.hourly.map(h => h.value),
            backgroundColor: DATA.hourly.map(h => h.value > 7000 ? '#10B981' : h.value > 5000 ? '#06B6D4' : '#002B61'),
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: '#262626' } }
          }
        }
      });
    }

    function renderHeatmap() {
      const container = document.getElementById('heatmapContainer');
      let html = '<div class="heatmap-grid">';

      // Header row
      html += '<div class="heatmap-label"></div>';
      for (let h = 0; h < 24; h++) {
        html += `<div class="heatmap-hour">${h}</div>`;
      }

      // Data rows (Monday start)
      DATA.heatmap.forEach(row => {
        html += `<div class="heatmap-label">${row.day}</div>`;
        row.hours.forEach(cell => {
          const intensity = cell.value / 100;
          const color = cell.value > 0
            ? `rgba(6, 182, 212, ${0.2 + intensity * 0.8})`
            : 'rgba(38, 38, 38, 1)';
          html += `<div class="heatmap-cell" style="background:${color}" data-value="${cell.value > 0 ? cell.value : ''}"></div>`;
        });
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function renderCategoryChart() {
      destroyChart('chartCategory');
      const ctx = document.getElementById('chartCategory').getContext('2d');
      chartInstances['chartCategory'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: DATA.categories.map(c => c.name),
          datasets: [{
            data: DATA.categories.map(c => c.value),
            backgroundColor: DATA.categories.map(c => c.color),
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              position: 'right',
              labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' }
            },
            tooltip: {
              callbacks: { label: ctx => ctx.label + ': ' + ctx.raw + '%' }
            }
          }
        }
      });
    }

    function renderCategoryBarChart() {
      destroyChart('chartCategoryBar');
      const ctx = document.getElementById('chartCategoryBar').getContext('2d');
      chartInstances['chartCategoryBar'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: DATA.categoryDetails.map(c => c.name),
          datasets: [{
            label: '売上（百万円）',
            data: DATA.categoryDetails.map(c => c.revenue / 1000000),
            backgroundColor: DATA.categories.map(c => c.color),
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => '¥' + ctx.raw.toFixed(0) + 'M (構成比: ' + DATA.categoryDetails[ctx.dataIndex].share + '%)'
              }
            }
          },
          scales: {
            x: {
              grid: { color: '#262626' },
              ticks: { callback: v => '¥' + v + 'M' }
            },
            y: { grid: { display: false } }
          }
        }
      });
    }

    function renderNetworkGraph() {
      const svg = d3.select('#networkSvg');
      svg.selectAll('*').remove();

      const width = svg.node().getBoundingClientRect().width;
      const height = 400;

      // Network data
      const nodes = DATA.categories.slice(0, 8).map((c, i) => ({
        id: c.name,
        group: i,
        value: c.value,
        color: c.color
      }));

      const links = [
        { source: '青果', target: '精肉', value: 0.68 },
        { source: '青果', target: '鮮魚', value: 0.52 },
        { source: '精肉', target: '惣菜', value: 0.71 },
        { source: '惣菜', target: '日配', value: 0.64 },
        { source: '日配', target: '飲料', value: 0.58 },
        { source: '飲料', target: '製菓', value: 0.45 },
        { source: '鮮魚', target: '酒類', value: 0.42 },
        { source: '青果', target: '日配', value: 0.55 },
        { source: '精肉', target: '飲料', value: 0.38 }
      ];

      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(50));

      const link = svg.append('g')
        .selectAll('line')
        .data(links)
        .enter().append('line')
        .attr('class', 'network-link')
        .attr('stroke', '#06B6D4')
        .attr('stroke-width', d => d.value * 5);

      const node = svg.append('g')
        .selectAll('circle')
        .data(nodes)
        .enter().append('circle')
        .attr('class', 'network-node')
        .attr('r', d => 15 + d.value)
        .attr('fill', d => d.color)
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      const label = svg.append('g')
        .selectAll('text')
        .data(nodes)
        .enter().append('text')
        .attr('class', 'network-label')
        .text(d => d.id);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('cx', d => d.x).attr('cy', d => d.y);
        label.attr('x', d => d.x).attr('y', d => d.y + 4);
      });

      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
    }

    function renderDemoBars() {
      const colors = { gender: ['#06B6D4', '#EC4899'], age: '#10B981', lifestage: '#F59E0B' };

      // Gender
      let html = '';
      DATA.genderDist.forEach((d, i) => {
        html += `<div class="demo-bar-container">
          <div class="demo-bar-label"><span>${d.label}</span><span>${d.value}%</span></div>
          <div class="demo-bar-track"><div class="demo-bar-fill" style="width:${d.value}%;background:${colors.gender[i]}"></div></div>
        </div>`;
      });
      document.getElementById('genderBars').innerHTML = html;

      // Age
      html = '';
      DATA.ageDist.forEach(d => {
        html += `<div class="demo-bar-container">
          <div class="demo-bar-label"><span>${d.label}</span><span>${d.value}%</span></div>
          <div class="demo-bar-track"><div class="demo-bar-fill" style="width:${d.value * 4}%;background:${colors.age}"></div></div>
        </div>`;
      });
      document.getElementById('ageBars').innerHTML = html;

      // Lifestage
      html = '';
      DATA.lifeDist.forEach(d => {
        html += `<div class="demo-bar-container">
          <div class="demo-bar-label"><span>${d.label}</span><span>${d.value}%</span></div>
          <div class="demo-bar-track"><div class="demo-bar-fill" style="width:${d.value * 3}%;background:${colors.lifestage}"></div></div>
        </div>`;
      });
      document.getElementById('lifeBars').innerHTML = html;
    }

    function renderRFMMatrix() {
      const container = document.getElementById('rfmMatrix');
      const fLabels = ['High', 'Mid', 'Low'];
      const rLabels = ['High', 'Mid', 'Low'];

      let html = '<div class="rfm-matrix">';
      html += '<div class="rfm-header"></div>';
      fLabels.forEach(f => html += `<div class="rfm-header">F:${f}</div>`);

      rLabels.forEach(r => {
        html += `<div class="rfm-row-label">R:${r}</div>`;
        fLabels.forEach(f => {
          const cell = DATA.rfm.find(c => c.r === r && c.f === f) || { count: 0, label: '-', color: '#262626' };
          html += `<div class="rfm-cell" style="background:${cell.color}">${cell.count > 0 ? cell.count.toLocaleString() : '-'}</div>`;
        });
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function renderPersonaRadars() {
      const container = document.getElementById('personaGrid');
      container.innerHTML = DATA.personas.map((p, i) => `
        <div class="persona-card">
          <div class="persona-name">${p.name}</div>
          <div class="persona-tag">${p.tag}</div>
          <div class="persona-chart"><canvas id="radarChart${i}"></canvas></div>
        </div>
      `).join('');

      DATA.personas.forEach((p, i) => {
        const ctx = document.getElementById(`radarChart${i}`).getContext('2d');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: Object.keys(p.scores),
            datasets: [{
              data: Object.values(p.scores),
              backgroundColor: p.color + '33',
              borderColor: p.color,
              borderWidth: 2,
              pointBackgroundColor: p.color,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: { display: false },
                grid: { color: '#404040' },
                pointLabels: { color: '#A3A3A3', font: { size: 10 } }
              }
            }
          }
        });
      });
    }

    function renderN1Profile() {
      const n = DATA.n1;
      document.getElementById('n1Name').textContent = n.name;
      document.getElementById('n1Tags').innerHTML = `
        <span class="n1-tag">${n.age}</span>
        <span class="n1-tag">${n.gender}</span>
        <span class="n1-tag">${n.lifestage}</span>
        <span class="n1-tag highlight">${n.rfmRank}</span>
      `;
      document.getElementById('n1Narrative').innerHTML = n.narrative;
      document.getElementById('n1Stats').innerHTML = `
        <div class="n1-stat"><div class="n1-stat-value">${n.stats.visits}</div><div class="n1-stat-label">来店回数/3M</div></div>
        <div class="n1-stat"><div class="n1-stat-value">¥${(n.stats.spend/1000).toFixed(0)}K</div><div class="n1-stat-label">累計購買額</div></div>
        <div class="n1-stat"><div class="n1-stat-value">¥${n.stats.basket.toLocaleString()}</div><div class="n1-stat-label">平均客単価</div></div>
        <div class="n1-stat"><div class="n1-stat-value">${n.stats.loyalty}</div><div class="n1-stat-label">ロイヤリティ</div></div>
      `;
    }

    /* ==================== SIMULATION: ABSTRACT RETAIL GRAPH ==================== */
    const NODES = [
      { id: 'entrance', label: 'ENTRANCE', x: 0.08, y: 0.5, color: '#10B981', size: 48, heat: 100 },
      { id: 'produce', label: 'PRODUCE', x: 0.25, y: 0.2, color: '#10B981', size: 42, heat: 85 },
      { id: 'meat', label: 'MEAT', x: 0.42, y: 0.15, color: '#F43F5E', size: 40, heat: 72 },
      { id: 'fish', label: 'FISH', x: 0.58, y: 0.2, color: '#06B6D4', size: 38, heat: 58 },
      { id: 'deli', label: 'DELI', x: 0.75, y: 0.28, color: '#F59E0B', size: 44, heat: 78 },
      { id: 'center', label: 'CENTER', x: 0.45, y: 0.52, color: '#8B5CF6', size: 50, heat: 65 },
      { id: 'beverage', label: 'BEVERAGE', x: 0.65, y: 0.6, color: '#14B8A6', size: 36, heat: 55 },
      { id: 'bakery', label: 'BAKERY', x: 0.28, y: 0.7, color: '#F59E0B', size: 34, heat: 48 },
      { id: 'frozen', label: 'FROZEN', x: 0.52, y: 0.82, color: '#3B82F6', size: 32, heat: 42 },
      { id: 'checkout', label: 'CHECKOUT', x: 0.92, y: 0.5, color: '#FFFFFF', size: 52, heat: 100 }
    ];

    const EDGES = [
      { from: 'entrance', to: 'produce', weight: 0.85 },
      { from: 'entrance', to: 'center', weight: 0.15 },
      { from: 'produce', to: 'meat', weight: 0.65 },
      { from: 'produce', to: 'center', weight: 0.35 },
      { from: 'meat', to: 'fish', weight: 0.55 },
      { from: 'meat', to: 'deli', weight: 0.35 },
      { from: 'meat', to: 'center', weight: 0.10 },
      { from: 'fish', to: 'deli', weight: 0.70 },
      { from: 'fish', to: 'center', weight: 0.30 },
      { from: 'deli', to: 'checkout', weight: 0.60 },
      { from: 'deli', to: 'beverage', weight: 0.40 },
      { from: 'center', to: 'beverage', weight: 0.45 },
      { from: 'center', to: 'bakery', weight: 0.35 },
      { from: 'center', to: 'frozen', weight: 0.20 },
      { from: 'beverage', to: 'checkout', weight: 0.75 },
      { from: 'beverage', to: 'frozen', weight: 0.25 },
      { from: 'bakery', to: 'frozen', weight: 0.40 },
      { from: 'bakery', to: 'center', weight: 0.30 },
      { from: 'bakery', to: 'checkout', weight: 0.30 },
      { from: 'frozen', to: 'checkout', weight: 1.00 }
    ];

    let simCanvas, simCtx, simRunning = false, simAnimId = null;
    let particles = [], simComplete = 0, simTotalTime = 0;

    function initSimulation() {
      simCanvas = document.getElementById('simCanvas');
      simCtx = simCanvas.getContext('2d');
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      drawStaticGraph();
    }

    function resizeCanvas() {
      const rect = simCanvas.parentElement.getBoundingClientRect();
      simCanvas.width = rect.width;
      simCanvas.height = 500;
      if (!simRunning) drawStaticGraph();
    }

    function getNodePos(node) {
      return {
        x: node.x * simCanvas.width,
        y: node.y * simCanvas.height
      };
    }

    function drawStaticGraph() {
      const ctx = simCtx;
      const W = simCanvas.width, H = simCanvas.height;

      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, W, H);

      // Draw edges
      ctx.strokeStyle = 'rgba(0, 43, 97, 0.6)';
      ctx.lineWidth = 2;
      EDGES.forEach(edge => {
        const fromNode = NODES.find(n => n.id === edge.from);
        const toNode = NODES.find(n => n.id === edge.to);
        if (fromNode && toNode) {
          const from = getNodePos(fromNode);
          const to = getNodePos(toNode);
          ctx.beginPath();
          ctx.moveTo(from.x, from.y);
          ctx.lineTo(to.x, to.y);
          ctx.stroke();
        }
      });

      // Draw nodes
      NODES.forEach(node => {
        const pos = getNodePos(node);
        const size = node.size * (node.heat / 100 * 0.3 + 0.7);

        // Glow
        const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, size * 1.5);
        gradient.addColorStop(0, node.color + '40');
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, size * 1.5, 0, Math.PI * 2);
        ctx.fill();

        // Hexagon
        ctx.fillStyle = node.color;
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
          const angle = (Math.PI / 3) * i - Math.PI / 6;
          const px = pos.x + size * Math.cos(angle);
          const py = pos.y + size * Math.sin(angle);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Label
        ctx.fillStyle = '#000000';
        ctx.font = 'bold 10px Montserrat';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(node.label, pos.x, pos.y);
      });
    }

    function spawnParticle() {
      const entrance = NODES.find(n => n.id === 'entrance');
      const pos = getNodePos(entrance);
      const hue = Math.random() * 60 + 160; // Cyan to green
      particles.push({
        x: pos.x,
        y: pos.y + (Math.random() - 0.5) * 40,
        currentNode: 'entrance',
        targetNode: null,
        progress: 0,
        speed: 0.008 + Math.random() * 0.006,
        startTime: performance.now(),
        color: `hsl(${hue}, 85%, 55%)`,
        trail: [],
        waiting: false,
        waitEnd: 0
      });
    }

    function getNextNode(currentId) {
      const possibleEdges = EDGES.filter(e => e.from === currentId);
      if (possibleEdges.length === 0) return null;

      const rand = Math.random();
      let cumulative = 0;
      for (const edge of possibleEdges) {
        cumulative += edge.weight;
        if (rand <= cumulative) return edge.to;
      }
      return possibleEdges[possibleEdges.length - 1].to;
    }

    function updateSimulation() {
      const now = performance.now();

      particles.forEach(p => {
        // Store trail
        p.trail.push({ x: p.x, y: p.y, age: 0 });
        if (p.trail.length > 25) p.trail.shift();
        p.trail.forEach(t => t.age++);

        // Waiting at node
        if (p.waiting) {
          if (now >= p.waitEnd) {
            p.waiting = false;
            p.targetNode = getNextNode(p.currentNode);
            if (!p.targetNode) {
              // Reached checkout
              p.remove = true;
              simComplete++;
              simTotalTime += (now - p.startTime) / 1000;
            }
            p.progress = 0;
          }
          return;
        }

        // Moving to target
        if (p.targetNode) {
          p.progress += p.speed;
          if (p.progress >= 1) {
            p.currentNode = p.targetNode;
            p.targetNode = null;
            p.progress = 0;
            p.waiting = true;
            p.waitEnd = now + 300 + Math.random() * 500;
          } else {
            const fromNode = NODES.find(n => n.id === p.currentNode);
            const toNode = NODES.find(n => n.id === p.targetNode);
            const from = getNodePos(fromNode);
            const to = getNodePos(toNode);

            // Curved path using easing
            const t = p.progress;
            const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
            p.x = from.x + (to.x - from.x) * ease;
            p.y = from.y + (to.y - from.y) * ease;
          }
        } else {
          // Just arrived, get next target
          p.targetNode = getNextNode(p.currentNode);
          if (!p.targetNode && p.currentNode !== 'checkout') {
            p.targetNode = 'checkout';
          }
        }
      });

      // Remove completed particles
      particles = particles.filter(p => !p.remove);

      // Update stats
      document.getElementById('simActive').textContent = particles.length;
      document.getElementById('simComplete').textContent = simComplete;
      document.getElementById('simAvgTime').textContent = simComplete > 0 ? (simTotalTime / simComplete).toFixed(1) : '0.0';
    }

    function renderSimulation() {
      const ctx = simCtx;
      const W = simCanvas.width, H = simCanvas.height;

      ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
      ctx.fillRect(0, 0, W, H);

      drawStaticGraph();

      // Draw particles with neon trails
      particles.forEach(p => {
        // Trail
        if (p.trail.length > 1) {
          ctx.beginPath();
          ctx.moveTo(p.trail[0].x, p.trail[0].y);
          for (let i = 1; i < p.trail.length; i++) {
            ctx.lineTo(p.trail[i].x, p.trail[i].y);
          }
          ctx.strokeStyle = p.color;
          ctx.lineWidth = 3;
          ctx.lineCap = 'round';
          ctx.globalAlpha = 0.6;
          ctx.stroke();
          ctx.globalAlpha = 1;
        }

        // Particle head
        const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 12);
        gradient.addColorStop(0, p.color);
        gradient.addColorStop(0.5, p.color + '80');
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 12, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function simLoop() {
      if (!simRunning) return;
      updateSimulation();
      renderSimulation();
      simAnimId = requestAnimationFrame(simLoop);
    }

    function toggleSimulation() {
      const btn = document.getElementById('simToggle');
      if (simRunning) {
        simRunning = false;
        cancelAnimationFrame(simAnimId);
        btn.textContent = 'START';
        btn.classList.remove('running');
        drawStaticGraph();
      } else {
        simRunning = true;
        particles = [];
        simComplete = 0;
        simTotalTime = 0;
        btn.textContent = 'STOP';
        btn.classList.add('running');

        // Spawn particles periodically
        const spawner = setInterval(() => {
          if (!simRunning) { clearInterval(spawner); return; }
          if (particles.length < 40) spawnParticle();
        }, 350);

        simLoop();
      }
    }

    /* ==================== TAB NAVIGATION ==================== */
    function initTabs() {
      const navBtns = document.querySelectorAll('.nav-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab;

          navBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(t => t.classList.remove('active'));

          btn.classList.add('active');
          document.getElementById('tab-' + tabId).classList.add('active');

          // Render tab-specific content
          if (tabId === 'trend') {
            setTimeout(() => {
              renderDailyChart();
              renderHourlyChart();
              renderHeatmap();
            }, 50);
          } else if (tabId === 'structure') {
            setTimeout(() => {
              renderCategoryChart();
              renderCategoryBarChart();
              renderNetworkGraph();
            }, 50);
          } else if (tabId === 'customer') {
            setTimeout(() => {
              renderDemoBars();
              renderRFMMatrix();
              renderPersonaRadars();
              renderN1Profile();
            }, 50);
          }
        });
      });
    }

    /* ==================== CSV UPLOAD ==================== */
    function initUpload() {
      const zone = document.getElementById('uploadZone');
      const input = document.getElementById('csvInput');

      zone.addEventListener('click', () => input.click());
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) parseCSV(file);
      });
      input.addEventListener('change', e => {
        if (e.target.files[0]) parseCSV(e.target.files[0]);
      });
    }

    function parseCSV(file) {
      Papa.parse(file, {
        header: true,
        encoding: 'Shift_JIS',
        skipEmptyLines: true,
        complete: results => {
          if (results.data && results.data.length > 0) {
            processCSVData(results.data, results.meta.fields);
            renderAll();
          }
        },
        error: err => console.error('CSV Parse Error:', err)
      });
    }

    function processCSVData(rows, headers) {
      const cols = {
        date: detectColumn(headers, COLUMN_ALIASES.date),
        amount: detectColumn(headers, COLUMN_ALIASES.amount),
        customerId: detectColumn(headers, COLUMN_ALIASES.customerId),
        gender: detectColumn(headers, COLUMN_ALIASES.gender),
        age: detectColumn(headers, COLUMN_ALIASES.age),
        category: detectColumn(headers, COLUMN_ALIASES.category),
        lifestage: detectColumn(headers, COLUMN_ALIASES.lifestage),
        hour: detectColumn(headers, COLUMN_ALIASES.hour)
      };

      // Filter out zero-amount rows
      const validRows = rows.filter(r => {
        const amt = parseFloat(r[cols.amount]) || 0;
        return amt > 0;
      });

      // Calculate KPIs
      let totalRevenue = 0;
      const customerSet = new Set();
      validRows.forEach(r => {
        totalRevenue += parseFloat(r[cols.amount]) || 0;
        if (cols.customerId && r[cols.customerId]) customerSet.add(r[cols.customerId]);
      });

      DATA.kpi.revenue = totalRevenue;
      DATA.kpi.transactions = validRows.length;
      DATA.kpi.basket = validRows.length > 0 ? Math.round(totalRevenue / validRows.length) : 0;
      DATA.kpi.frequency = customerSet.size > 0 ? (validRows.length / customerSet.size).toFixed(1) : 0;

      // Process demographics if available
      if (cols.gender) {
        const genderCounts = {};
        validRows.forEach(r => {
          const g = r[cols.gender];
          if (g) genderCounts[g] = (genderCounts[g] || 0) + 1;
        });
        const total = Object.values(genderCounts).reduce((a, b) => a + b, 0);
        DATA.genderDist = sortByOrder(
          Object.entries(genderCounts).map(([label, count]) => ({ label, value: Math.round(count / total * 100) })),
          'gender'
        );
      }

      if (cols.age) {
        const ageCounts = {};
        validRows.forEach(r => {
          const a = r[cols.age];
          if (a) ageCounts[a] = (ageCounts[a] || 0) + 1;
        });
        const total = Object.values(ageCounts).reduce((a, b) => a + b, 0);
        DATA.ageDist = sortByOrder(
          Object.entries(ageCounts).map(([label, count]) => ({ label, value: Math.round(count / total * 100) })),
          'age'
        );
      }

      if (cols.lifestage) {
        const lifeCounts = {};
        validRows.forEach(r => {
          const l = r[cols.lifestage];
          if (l) lifeCounts[l] = (lifeCounts[l] || 0) + 1;
        });
        const total = Object.values(lifeCounts).reduce((a, b) => a + b, 0);
        DATA.lifeDist = sortByOrder(
          Object.entries(lifeCounts).map(([label, count]) => ({ label, value: Math.round(count / total * 100) })),
          'lifestage'
        );
      }

      // Update node heat based on category data
      if (cols.category) {
        const catCounts = {};
        validRows.forEach(r => {
          const c = r[cols.category];
          if (c) catCounts[c] = (catCounts[c] || 0) + 1;
        });
        // Dynamically update node sizes based on category popularity
        const maxCount = Math.max(...Object.values(catCounts));
        NODES.forEach(node => {
          const nodeCategories = {
            'produce': ['青果', '野菜', 'PRODUCE'],
            'meat': ['精肉', '肉', 'MEAT'],
            'fish': ['鮮魚', '魚', 'FISH'],
            'deli': ['惣菜', 'DELI'],
            'center': ['日配', '加工食品', 'CENTER'],
            'beverage': ['飲料', 'BEVERAGE'],
            'bakery': ['パン', 'ベーカリー', 'BAKERY'],
            'frozen': ['冷凍', 'FROZEN']
          };
          const matchingCats = nodeCategories[node.id] || [];
          let nodeCount = 0;
          matchingCats.forEach(cat => {
            Object.keys(catCounts).forEach(k => {
              if (k.includes(cat)) nodeCount += catCounts[k];
            });
          });
          if (nodeCount > 0 && maxCount > 0) {
            node.heat = Math.round((nodeCount / maxCount) * 100);
          }
        });
      }
    }

    function renderAll() {
      renderKPI();
      drawStaticGraph();
    }

    /* ==================== INITIALIZATION ==================== */
    function init() {
      generateDemoData();
      renderKPI();
      initSimulation();
      initTabs();
      initUpload();

      // Simulation toggle
      document.getElementById('simToggle').addEventListener('click', toggleSimulation);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
